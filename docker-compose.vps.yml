version: '3.8'

services:
  # ðŸ”’ Nginx
  nginx:
    build:
      context: ./asmo-backend/nginx
      dockerfile: Dockerfile.prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/production.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt/live/your-domain.com:/etc/ssl/certs:ro
      - /etc/letsencrypt/live/your-domain.com:/etc/ssl/private:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - backend
      - frontend
    networks:
      - asmo-network
    restart: unless-stopped

  # ðŸ–¥ï¸ Backend (Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹)
  backend:
    build:
      context: ./asmo-backend/backend
      dockerfile: Dockerfile.prod
    environment:
      - ENVIRONMENT=production
      - PORT=3000
      - LOG_LEVEL=INFO
      - GIN_MODE=release
      # Database (Ð¸Ð· Ð²Ð°ÑˆÐµÐ³Ð¾ config.go)
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=asmo_prod_user
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=asmo_production
      - DB_SSL_MODE=require
      # Redis (Ð²Ð°Ð¶Ð½Ð¾: Ñ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¼)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=0
      # CORS (ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž Ð´Ð»Ñ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð° Ð² Docker)
      - ALLOWED_ORIGINS=https://${DOMAIN},http://frontend:3001,http://localhost:3001
      # Monitoring
      - PROMETHEUS_METRICS=true
      # ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
      - MIGRATIONS_PATH=/app/backend/migrations
    volumes:
      - ./asmo-backend/backend/migrations:/app/backend/migrations:ro
      - backend-logs:/app/logs
    depends_on:
      - postgres
      - redis
    networks:
      - asmo-network
    command: >
      sh -c "
      echo 'Running migrations...' &&
      ./migrate up &&
      echo 'Starting server...' &&
      ./main
      "
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸŽ¨ Frontend (Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Dockerfile)
  frontend:
    build:
      context: ./asmo-frontend
      dockerfile: Dockerfile.prod
      args:
        - NEXT_PUBLIC_API_URL=/api  # ÐžÑ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· nginx
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=/api
      - PORT=3001
    networks:
      - asmo-network
    volumes:
      - frontend-cache:/app/.next/cache
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸ—„ï¸ PostgreSQL
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=asmo_production
      - POSTGRES_USER=asmo_prod_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF8
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    networks:
      - asmo-network
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.track=all
      -c max_connections=200

  # ðŸŽ¯ Redis (Ñ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¼)
  redis:
    image: redis:7-alpine
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - asmo-network

networks:
  asmo-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  backend-logs:
  frontend-cache:
  nginx-logs: